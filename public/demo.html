<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enigma Bridge REST demo</title>
    <style>
        body,div,p,a,td,input {font-family: Arial, Helvetica, sans-serif; font-size: 10pt;}
        h1 {font-size: 14pt; }
        h2 {font-size: 12pt; }
        #footer {font-size: 8pt; text-align: center; padding: 0 10px 10px 10px}
        #status {background-color: #C1C1FF; padding: 10px 10px 10px 10px; font-family: monospace; margin-top: 10px;}
        .preformatted { font-family: monospace;  white-space: pre;}
    </style>
    <script src="jquery-1.12.1.min.js"></script>
    <script src="sprintf.js"></script>
    <script src="sjcl.js"></script>
    <script src="enigma.js"></script>
</head>
<body>

<form name="dataPost">
    <label for="data">Data: </label>
    <input type="text" id="data" name="data" size="80" title="Data" value="6bc1bee22e409f96e93d7e117393172a"/>
    <input type="submit" value="Submit"/>
</form>
<div id="status"></div>

<script>
    // Use server.js to start a new static page server with CORS (cross domain resource sharing).
    // UO Key: 11223344556677889900aabbccddeeff
    // CommKeyENC: e134567890123456789012345678901234567890123456789012345678901234
    // CommKeyMAC: e224262820223456789012345678901234567890123456789012345678901234

    function display_message(msg)
    {
        $("#status")[0].innerHTML = msg;
    }

    function doRequest(data)
    {
        // Sanity checks
        if (!data)
            return display_message("Data is empty");

        // Keys
        var aesAppKey = "11223344556677889900aabbccddeeff";
        var aesKey = "e134567890123456789012345678901234567890123456789012345678901234";
        var macKey = "e224262820223456789012345678901234567890123456789012345678901234";
        var keyId = 0xee01;
        var plainData = sjcl.codec.utf8String.toBits("");
        var requestData = sjcl.codec.hex.toBits(data); //sjcl.codec.utf8String.toBits(data);

        //<userAPI>/<version>/ProcessData/<nonce>
        var apiKey = sprintf("%s%010x", "API_TEST", keyId);
        var apiVersion = "1.0";
        var command = "ProcessData";

        // Build a new EB request.
        var reqBuilder = new eb.comm.requestBuilder();
        reqBuilder.aesKey = aesKey;
        reqBuilder.macKey = macKey;
        reqBuilder.userObjectId = keyId;
        reqBuilder.reqType = "PLAINAES";
        reqBuilder.debuggingLog = true;
        reqBuilder.nonce = "0000000000000000"; // for testing only.
        reqBuilder.genNonce();

        var requestBlock = reqBuilder.build(plainData, requestData);
        var nonce = reqBuilder.nonce;

        console.log("Nonce: " + nonce);
        console.log("request block: " + requestBlock);

        // AJAX call
        var method = "GET";
        var endpointUrl;
        var endpointRequestData;
        if (method == "POST"){
            endpointUrl = sprintf("https://dragonfly.smarthsm.net:11180/%s/%s/%s/%s",
                    apiKey, apiVersion, command, nonce);
            endpointRequestData = {data: requestBlock};

        } else if (method == "GET"){
            endpointUrl = sprintf("https://dragonfly.smarthsm.net:11180/%s/%s/%s/%s/%s",
                    apiKey, apiVersion, command, nonce, requestBlock);
            endpointRequestData = {};

        }

        console.log("URL: " + endpointUrl + ", method: " + method);
        console.log("UserData: " + JSON.stringify(endpointRequestData));

        // Build JSON request for pure socket query
        socketReq = {
            objectid:apiKey,
            data:requestBlock,
            function:command,
            nonce:nonce,
            version:apiVersion};
        console.log("SocketReq: " + JSON.stringify(socketReq));

        // Testvector:   {"objectid":"API_TEST0000005544","data":"Packet0_PLAINAES_00004bcd596b3afe9ab1ca440061edcb41729c5a700afdb611175f7543cafcc0e69ee2f07a1b8bf7a9e729523eb38af5f90a","function":"ProcessData","nonce":"334613358783577","version":"1.0"}
        // Testresponse: {"function":"ProcessData","result":"0000d2953f6701ec054e95a0ea6b3760c9598b0e69177cae18d13b9004574ae7d6a746ae82c876167f6c9bf74a1fd162d779_Packet0_PLAINAES_","status":"9000","statusdetail":"(OK)SW_STAT_OK","version":"1.0"}
        processAnswer = function(data){
            h = sjcl.codec.hex;

            // Build a new EB request.
            var parser = new eb.comm.responseParser();
            parser.aesKey = aesKey;
            parser.macKey = macKey;
            parser.debuggingLog = true;
            var responseBody = parser.parse(data);
            if (parser.success()){
                console.log("Processing complete, response: " + h.fromBits(responseBody));
            } else {
                console.log("Failure, status: " + parser.statusCode);
            }
        };

        // Do the remote call
        $.ajax({
            url: endpointUrl,
            type: method,
            dataType: 'json',
            data: endpointRequestData,
            timeout: 7000
        }).done(function(data, textStatus, jqXHR){
            console.log("Done: " + textStatus);
            display_message(JSON.stringify(data));
            processAnswer(data);

        }).fail(function(jqXHR, textStatus, errorThrown) {
            var msg = sprintf("Error: status=%d, responseText: %s, error: %s", xhr.status, xhr.responseText, thrownError);
            console.log("Error: " + msg);
            display_message(msg);

        }).always(function(data, textStatus, jqXHR) {
            console.log("Complete");
        });
    }

    $(function(){
        // Start random number collectors.
        sjcl.random.startCollectors();

        // Submit button action.
        $('form[name=dataPost]').submit(function(){
            doRequest($(this).find('#data').val());
            return false;
        });
    });

</script>

</body>
</html>