<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enigma Bridge REST demo</title>
    <style>
        body,div,p,a,td,input {font-family: Arial, Helvetica, sans-serif; font-size: 10pt;}
        h1 {font-size: 14pt; }
        h2 {font-size: 12pt; }
        #footer {font-size: 8pt; text-align: center; padding: 0 10px 10px 10px}
        #status {background-color: #C1C1FF; padding: 10px 10px 10px 10px; font-family: monospace;  white-space: pre; margin-top: 10px;}
        .preformatted { font-family: monospace;  white-space: pre;}
    </style>
    <script src="jquery-1.12.1.min.js"></script>
    <script src="sprintf.js"></script>
    <script src="sjcl.js"></script>
    <script src="enigma.js"></script>
</head>
<body>

<form name="dataPost">
    <label for="data">Data: </label>
    <input type="text" id="data" name="data" size="80" title="Data"/>
    <input type="submit" value="Submit"/>
</form>
<div id="status"></div>

<script>
    // Use server.js to start a new static page server with CORS (cross domain resource sharing).
    // UO Key: 11223344556677889900aabbccddeeff
    // CommKeyENC: e134567890123456789012345678901234567890123456789012345678901234
    // CommKeyMAC: e224262820223456789012345678901234567890123456789012345678901234

    function display_message(msg)
    {
        $("#status")[0].innerHTML = msg;
    }

    function doRequest(data)
    {
        // Sanity checks
        if (!data)
            return display_message("Data is empty");

        // Keys
        var aesAppKey = "11223344556677889900aabbccddeeff";
        var aesKey = "e134567890123456789012345678901234567890123456789012345678901234";
        var macKey = "e224262820223456789012345678901234567890123456789012345678901234";
        var keyId = 0x5544;
        var plainData = sjcl.codec.utf8String.toBits("");

        //<userAPI>/<version>/ProcessData/<nonce>
        var apiKey = "API_TEST0000005544";
        var apiVersion = "1.0";
        var command = "ProcessData";
        var nonce = eb.misc.genHexNonce(16);

        var requestBlock = "Packet0_PLAINAES_00004bcd596b3afe9ab1ca440061edcb41729c5a700afdb611175f7543cafcc0e69ee2f07a1b8bf7a9e729523eb38af5f90a";
        console.log("Nonce: " + nonce);

        // Data format before encryption:
        // buff = 0x1f | <UOID-4B> | userdata
        //
        // Encryption
        // AES-256/CBC/PKCS7, IV = 0x00000000000000000000000000000000
        //
        // MAC
        // AES-256-CBC-MAC.
        //
        // encBlock = enc(buff)
        // result = encBlock || mac(plaindata || encBlock)
        //
        // output = Packet0| _PLAINAES_ | <plain-data-length-4B> | <plaindata> | hexcode(result)
        try {
            h = sjcl.codec.hex;
            ba = sjcl.bitArray;
            pad = eb.padding.pkcs7;

            // Plain data is empty for now.
            var baPlain = plainData;
            var plainDataLength = ba.bitLength(baPlain)/8;

            // Input data flag
            var baBuff = h.toBits("0x1f");
            // User Object ID
            baBuff = ba.concat(baBuff, h.toBits(sprintf("%04x", keyId)));
            // Freshness nonce
            baBuff = ba.concat(baBuff, h.toBits(nonce));
            // User data
            baBuff = ba.concat(baBuff, sjcl.codec.utf8String.toBits(data));
            // Add padding.
            baBuff = pad.pad(baBuff);
            console.log("baBuff: " + h.fromBits(baBuff) + "; len: " + ba.bitLength(baBuff));

            var aesKeyBits = h.toBits(aesKey);
            var macKeyBits = h.toBits(macKey);

            aes = new sjcl.cipher.aes(aesKeyBits);
            aesMac = new sjcl.cipher.aes(macKeyBits);
            hmac = new sjcl.misc.hmac_cbc(aesMac);

            // IV is null, nonce in the first block is kind of IV.
            var IV = h.toBits("00000000000000000000000000000000");
            var encryptedData = sjcl.mode.cbc.encrypt(aes, baBuff, IV, []);
            console.log("encrypted: " + h.fromBits(encryptedData));

            // include plain data in the MAC if non-empty.
            var toMac = encryptedData;
            if (plainDataLength > 0){
                toMac = ba.concat(baPlain, encryptedData);
                toMac = pad.pad(toMac);
            }

            var hmacData = hmac.mac(toMac);
            console.log("hmacData: " + h.fromBits(hmacData));

            // Build the request block.
            var requestBase = sprintf("Packet0_PLAINAES_%04X%s%s%s",
                    plainDataLength,
                    h.fromBits(plainData),
                    h.fromBits(encryptedData),
                    h.fromBits(hmacData)
            );
            console.log("request: " + requestBase);
        }
        catch (err) {
            console.log("Error: " + err);
        }

        var endpointUrl = sprintf("https://dragonfly.smarthsm.net/%s/%s/%s/%s",
                apiKey, apiVersion, command, nonce);

        console.log("URL: " + endpointUrl);
        console.log("UserData: " + requestBlock);

        // Do the remote call
        $.ajax({
            url: endpointUrl,
            type: 'POST',
            dataType: 'json',
            data: {data: requestBlock},
            timeout: 7000,

            done: function (data, textStatus, jqXHR) {
                console.log("Done: " + data);
                display_message(data);
                // var r = jQuery.parseJSON(response.responseText);
                //jQuery("#usergrid").trigger("reloadGrid");
            },
            error: function (xhr, ajaxOptions, thrownError) {
                var msg = sprintf("Error: status=%d, responseText: %s, error: %s", xhr.status, xhr.responseText, thrownError);
                console.log("Error: " + msg);
                display_message(msg);
            },
            always: function() {
                console.log("Complete");
            }
        });
    }

    $(function(){
        // Start random number collectors.
        sjcl.random.startCollectors();

        // Submit button action.
        $('form[name=dataPost]').submit(function(){
            doRequest($(this).find('#data').val());
            return false;
        });
    });

</script>

</body>
</html>