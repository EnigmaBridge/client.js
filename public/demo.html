<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enigma Bridge REST demo</title>
    <style>
        body,div,p,a,td,input {font-family: Arial, Helvetica, sans-serif; font-size: 10pt;}
        h1 {font-size: 14pt; }
        h2 {font-size: 12pt; }
        #footer {font-size: 8pt; text-align: center; padding: 0 10px 10px 10px}
        #status {background-color: #C1C1FF; padding: 10px 10px 10px 10px; font-family: monospace;  white-space: pre; margin-top: 10px;}
        .preformatted { font-family: monospace;  white-space: pre;}
    </style>
    <script src="jquery-1.12.1.min.js"></script>
    <script src="sprintf.js"></script>
    <script src="sjcl.js"></script>
    <script src="enigma.js"></script>
</head>
<body>

<form name="dataPost">
    <label for="data">Data: </label>
    <input type="text" id="data" name="data" size="80" title="Data"/>
    <input type="submit" value="Submit"/>
</form>
<div id="status"></div>

<script>
    // When developing locally, you can use socat to bypass same origin policy:
    // socat TCP-LISTEN:11180,fork TCP:enigmabridge.com:11180
    // Update: port is checked as well... Socat does not help.

    // TODO: development node.js server. With CORS (cross domain resource sharing), adding
    // TODO: an exception to the same origin policy settings. Do not use JSONP as it poses a security threat.
    // TODO: in production, modify HTTP headers and set acceptable CORS domain (e.g., with PHP, header()), or configure
    // TODO: a reverse proxy in the hosting HTTP server, so enigma/ goes to the remote endpoint.

    function display_message(msg)
    {
        $("#status")[0].innerHTML = msg;
    }

    function doRequest(data)
    {
        // Sanity checks
        if (!data)
            return display_message("Data is empty");

        //<userAPI>/<version>/ProcessData/<nonce>
        var apiKey = "API_TEST0000005544";
        var apiVersion = "1.0";
        var command = "ProcessData";
        var nonce = ebGenNonce(16);
//        var userData = data.hexEncode();
        var userData = "Packet0_PLAINAES_00004bcd596b3afe9ab1ca440061edcb41729c5a700afdb611175f7543cafcc0e69ee2f07a1b8bf7a9e729523eb38af5f90a";

        // dragonfly.smarthsm.net
        var endpointUrl = sprintf("https://localhost:11180/%s/%s/%s/%s",
                apiKey, apiVersion, command, nonce);
        console.log("URL: " + endpointUrl);
        console.log("UserData: " + userData);

        // Do the remote call
        $.ajax({
            url: endpointUrl,
            type: 'POST',
            dataType: 'json',
            data: {data: userData},
            timeout: 7000,

            done: function (data, textStatus, jqXHR) {
                console.log("Done: " + data);
                display_message(data);
                // var r = jQuery.parseJSON(response.responseText);
                //jQuery("#usergrid").trigger("reloadGrid");
            },
            error: function (xhr, ajaxOptions, thrownError) {
                var msg = sprintf("Error: status=%d, responseText: %s, error: %s", xhr.status, xhr.responseText, thrownError);
                console.log("Error: " + msg);
                display_message(msg);
            },
            always: function() {
                console.log("Complete");
            }
        });
    }

    $(function(){
        // Start random number collectors.
        sjcl.random.startCollectors();

        // Submit button action.
        $('form[name=dataPost]').submit(function(){
            doRequest($(this).find('#data').val());
            return false;
        });
    });

</script>

</body>
</html>