<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enigma Bridge REST demo</title>
    <style>
        body,div,p,a,td,input {font-family: Arial, Helvetica, sans-serif; font-size: 10pt;}
        h1 {font-size: 14pt; }
        h2 {font-size: 12pt; }
        #footer {font-size: 8pt; text-align: center; padding: 0 10px 10px 10px}
        #status {background-color: #C1C1FF; padding: 10px 10px 10px 10px; font-family: monospace; margin-top: 10px;}
        .preformatted { font-family: monospace;  white-space: pre;}
    </style>
    <script src="jquery-1.12.1.min.js"></script>
    <script src="sprintf.js"></script>
    <script src="sjcl.js"></script>
    <script src="enigma.js"></script>
</head>
<body>

<form name="dataPost">
    <label for="data">Data: </label>
    <input type="text" id="plainData" name="plainData" size="20" title="PlainData" value=""/>
    <input type="text" id="data" name="data" size="80" title="Data" value="6bc1bee22e409f96e93d7e117393172a"/>
    <input type="button" id="btnProcessData" value="ProcessData"/>
    <input type="button" id="btnProcessDataPadding" value="ProcessData (padding)"/>
</form>
<div id="status"></div>

<script>
    // Use server.js to start a new static page server with CORS (cross domain resource sharing).
    // UO Key: 11223344556677889900aabbccddeeff
    // CommKeyENC: e134567890123456789012345678901234567890123456789012345678901234
    // CommKeyMAC: e224262820223456789012345678901234567890123456789012345678901234

    function display_message(msg) {
        $("#status")[0].innerHTML = msg;
    }

    function formatDate(date) {
        var hours = date.getHours();
        var minutes = date.getMinutes();
        var ampm = hours >= 12 ? 'pm' : 'am';
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'
        minutes = minutes < 10 ? '0'+minutes : minutes;
        var strTime = hours + ':' + minutes + ' ' + ampm;
        return date.getMonth()+1 + "/" + date.getDate() + "/" + date.getFullYear() + "  " + strTime;
    }

    function append_message(msg) {
        var status = $("#status");
        var newMsg = formatDate(new Date()) + " - " + msg;
        status.html(status.html() + "<br/>\n" + newMsg);
    }

    function log(msg){
        console.log(msg);
        append_message(msg);
    }

    function requestSimple(dataInp, plainDataInp, doPadding){
        h = sjcl.codec.hex;
        var aesKey = "e134567890123456789012345678901234567890123456789012345678901234";
        var macKey = "e224262820223456789012345678901234567890123456789012345678901234";
        var keyId = 0xee01;
        var plainData = h.toBits(plainDataInp || "");
        var requestData = h.toBits(dataInp || ""); //sjcl.codec.utf8String.toBits(data);

        if (doPadding){
            pad = eb.padding.pkcs7;
            requestData = pad.pad(requestData);
            append_message("Padded req: " + h.fromBits(requestData));
        }

        var logger = function(msg) {
            append_message(msg);
        };

        var request = new eb.comm.request();
        request.aesKey = aesKey;
        request.macKey = macKey;
        request.apiKey = "API_TEST";
        request.userObjectId = keyId;

        // Advanced settings.
        request.remoteEndpoint = "dragonfly.smarthsm.net";
        request.remotePort = 11180;
        request.requestMethod = "POST";
        request.requestScheme = "https";
        request.requestTimeout = 7000;
        request.callFunction = "ProcessData";
        request.callRequestType = "PLAINAES";

        // Logging settings.
        request.debuggingLog = true;
        request.logger = logger;

        // Callbacks settings.
        request.done(function(response, requestObj, jqXHR) {
            console.log("DONE! " + h.fromBits(response.protectedData));

        }).fail(function(failType, jqXHR, textStatus, errorThrown, requestObj){
            console.log("fail! type=" + failType);

        }).always(function(request){
            console.log("it is over...");
        });

        // Do the call.
        request.call(plainData, requestData);
    }

    $(function(){
        // Start random number collectors.
        sjcl.random.startCollectors();

        // Button click handling.
        // in form search: $(this).find('#data').val());
        $('#btnProcessData').click(function(){
            requestSimple($('#data').val(), $('#plainData').val(), false);
        });

        $('#btnProcessDataPadding').click(function(){
            requestSimple($('#data').val(), $('#plainData').val(), true);
        });
    });

</script>

</body>
</html>