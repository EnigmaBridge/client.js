<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enigma Bridge REST demo</title>
    <style>
        body,div,p,a,td,input {font-family: Arial, Helvetica, sans-serif; font-size: 10pt;}
        h1 {font-size: 14pt; }
        h2 {font-size: 12pt; }
        #footer {font-size: 8pt; text-align: center; padding: 0 10px 10px 10px}
        .logbox {
            background-color: #2A88AD;
            padding: 10px 10px 10px 10px;
            font-family: monospace;
            margin-top: 10px;
            margin-right: 10px;
            color: #f9f9f9;
            overflow: auto;
            width: 99%;
            white-space: pre-wrap;       /* CSS 3 */
            white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
            white-space: -o-pre-wrap;    /* Opera 7 */
            word-wrap: break-word;       /* Internet Explorer 5.5+ */}
    </style>
    <link href='http://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'/>
    <link rel="stylesheet" type="text/css" href="forms.css"/>
    <script src="jquery-1.12.1.min.js"></script>
    <script src="sprintf.js"></script>
    <script src="sjcl.js"></script>
    <script src="enigma.js"></script>
</head>
<body>

<!-- form design: http://www.sanwebe.com/2014/08/css-html-forms-designs -->
<div class="form-style-10">
    <h1>EnigmaBridge API test<span>API usage demo</span></h1>
    <form>
        <div class="section"><span>1</span>Function input</div>
        <div class="inner-wrap">
            <label>
                Plain data
                <input type="text" name="plainData" id="plainData" placeholder="Plain data (can be empty)"/>
                <span>Aux data, not protected by MAC or cipher</span>
            </label>

            <label>
                Function input
                <input type="text" name="data" id="data" placeholder="Function input"/>
                <span>Input data to the <em>ProcessData()</em>. Will be encypted and MACed in transfer.
                    TestVector: <a onclick="$('#data').val('6bc1bee22e409f96e93d7e117393172a');">6bc1bee22e409f96e93d7e117393172a</a>
                </span>
            </label>
        </div>

        <div class="section"><span>2</span>Configuration</div>
        <div class="inner-wrap">
            <label>API Key
                <input type="text" name="apiKey" id="apiKey" value="TEST_API"/>
                <span>Your EB API key</span>
            </label>

            <label>User object ID
                <input type="text" name="userObjectID" id="userObjectID" value="EE01"/>
                <span>Hexcoded user object ID stored in EB you want to work with</span>
            </label>

            <label>Endpoint
                <input type="text" name="endpoint" id="endpoint" value="dragonfly.smarthsm.net"/>
                <span>Hostname of the EB API</span>
            </label>

            <label>Method
                <select id="requestMethod" name="requestMethod">
                    <option value="POST">POST</option>
                    <option value="GET">GET</option>
                </select>
            </label>

            <label>AES encryption key
                <input type="text" name="aesKey" id="aesKey" value="e134567890123456789012345678901234567890123456789012345678901234"/>
                <span>Hexcoded encryption API key</span>
            </label>

            <label>MAC key
                <input type="text" name="macKey" id="macKey" value="e224262820223456789012345678901234567890123456789012345678901234"/>
                <span>Hexcoded hmac API key</span>
            </label>

        </div>
        <div class="button-section">
            <input type="button" id="btnProcessData" value="ProcessData"/>
            <input type="button" id="btnProcessDataPadding" value="ProcessData (padding)"/>
        </div>
    </form>
</div>

<label for="reqRest">Request: </label>
<div id="reqRest" class="logbox"></div>
<br/>

<label for="status">Log: </label>
<div id="status" class="logbox"></div>

<script>
    // Use server.js to start a new static page server with CORS (cross domain resource sharing).
    // UO Key: 11223344556677889900aabbccddeeff
    // CommKeyENC: e134567890123456789012345678901234567890123456789012345678901234
    // CommKeyMAC: e224262820223456789012345678901234567890123456789012345678901234

    function set_request(msg){
        $("#reqRest")[0].innerHTML = msg;
    }

    function display_message(msg) {
        $("#status")[0].innerHTML = msg;
    }

    function formatDate(date) {
        var hours = date.getHours();
        var minutes = date.getMinutes();
        var ampm = hours >= 12 ? 'pm' : 'am';
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'
        minutes = minutes < 10 ? '0'+minutes : minutes;
        var strTime = hours + ':' + minutes + ' ' + ampm;
        return date.getMonth()+1 + "/" + date.getDate() + "/" + date.getFullYear() + "  " + strTime;
    }

    function append_message(msg) {
        var status = $("#status");
        var newMsg = formatDate(new Date()) + " - " + msg;
        status.html(status.html() + "<br/>\n" + newMsg);
    }

    function log(msg){
        console.log(msg);
        append_message(msg);
    }

    function requestSimple(dataInp, plainDataInp, doPadding){
        h = sjcl.codec.hex;
        var apiKey = $('#apiKey').val();
        var aesKey = $('#aesKey').val();
        var macKey = $('#macKey').val();
        var keyId = parseInt($('#userObjectID').val(), 16);
        var endpoint = $('#endpoint').val();
        var method = $('#requestMethod').val();

        var plainData = h.toBits(plainDataInp || "");
        var requestData = h.toBits(dataInp || ""); //sjcl.codec.utf8String.toBits(data);

        if (doPadding){
            pad = eb.padding.pkcs7;
            requestData = pad.pad(requestData);
            append_message("Padded req: " + h.fromBits(requestData));
        }

        // Flush old messages.
        display_message("");
        set_request("");

        var logger = function(msg) {
            append_message(msg);
        };

        var request = new eb.comm.request();
        request.aesKey = aesKey;
        request.macKey = macKey;
        request.apiKey = apiKey;
        request.userObjectId = keyId;

        // Advanced settings.
        request.remoteEndpoint = endpoint;
        request.remotePort = 11180;
        request.requestMethod = method;
        request.requestScheme = "https";
        request.requestTimeout = 7000;
        request.callFunction = "ProcessData";
        request.callRequestType = "PLAINAES";

        // Logging settings.
        request.debuggingLog = true;
        request.logger = logger;

        // Callbacks settings.
        request.done(function(response, requestObj, jqXHR) {
            console.log("DONE! " + h.fromBits(response.protectedData));

        }).fail(function(failType, jqXHR, textStatus, errorThrown, requestObj){
            console.log("fail! type=" + failType);

        }).always(function(request){
            console.log("it is over...");
        });

        // Build the request so we can display request in the form.
        request.build(plainData, requestData);
        set_request(sprintf("%s<br/>\n%s<br/>\n%s<br/>\n",
                request.getApiUrl(),
                JSON.stringify(request.getApiRequestData()),
                JSON.stringify(request.getSocketRequest())));

        // Do the call.
        request.call();
    }

    $(function(){
        // Start random number collectors.
        sjcl.random.startCollectors();

        // Button click handling.
        // in form search: $(this).find('#data').val());
        $('#btnProcessData').click(function(){
            requestSimple($('#data').val(), $('#plainData').val(), false);
        });

        $('#btnProcessDataPadding').click(function(){
            requestSimple($('#data').val(), $('#plainData').val(), true);
        });
    });

</script>

</body>
</html>