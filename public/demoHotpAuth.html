<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enigma Bridge REST demo</title>
    <style>
        body,div,p,a,td,input {font-family: Arial, Helvetica, sans-serif; font-size: 10pt;}
        h1 {font-size: 14pt; }
        h2 {font-size: 12pt; }
        #footer {font-size: 8pt; text-align: center; padding: 0 10px 10px 10px}
        .hotpCode{
            padding: 0px 10px 15px 10px;
            font-size: 24pt;
        }
        input[disabled]{
            background-color: #F8F8F8;
        }
        .logbox {
            background-color: #2A88AD;
            padding: 10px 10px 10px 10px;
            font-family: monospace;
            margin-top: 10px;
            margin-right: 10px;
            color: #f9f9f9;
            overflow: auto;
            width: 99%;
            white-space: pre-wrap;       /* CSS 3 */
            white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
            white-space: -o-pre-wrap;    /* Opera 7 */
            word-wrap: break-word;       /* Internet Explorer 5.5+ */}
    </style>
    <link href='http://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'/>
    <link rel="stylesheet" type="text/css" href="forms.css"/>
    <script src="jquery-1.12.1.min.js"></script>
    <script src="sprintf.js"></script>
    <script src="sjcl.js"></script>
    <script src="enigma.js"></script>
    <script>
        "use strict";
        var defaults = {
            uoidHotp: 5588,
            uoidPasswd: 5599,
            methodHotp:'AUTH_HOTP',
            methodPasswd:'AUTH_PASSWD',
            site: 'site2.enigmabridge.com',
            site1: 'site1.enigmabridge.com',
            site2: 'site2.enigmabridge.com'
        };

        // Update context flag.
        var updateCtxFlag=false;
    </script>
</head>
<body>

<!-- form design: http://www.sanwebe.com/2014/08/css-html-forms-designs -->
<!-- info: http://jacob.jkrall.net/totp/ -->
<div class="form-style-10">
    <h1>EnigmaBridge HOTP API test<span>HOTP authentication demo</span></h1>
    <form>

        <div class="section"><span>1</span>Client HOTP device</div>
        <div class="inner-wrap">
            <label>HOTP secret
                <input type="text" name="hotpSecret" id="hotpSecret" placeholder="HOTP secret key"/>
                <span>HOTP secret key for the user, used for HOTP token initialization</span>
            </label>

            <label>Counter
                <input type="text" name="hotpCtr" id="hotpCtr" value="0000000000000001"/>
                <span>Counter for HOTP derivation</span>
            </label>

            <div id="hotpCodeDiv" class="hotpCode"></div>
            <div class="button-section">
                <input type="button" id="btnGenerate" value="Generate"/>
                <!-- Buggy counter computation not needed anymore. FIXED on the server side.
                <input type="button" id="btnGenerateBug" value="Generate - with ctr bug"/>
                -->
            </div>
        </div>

        <div class="section"><span>2</span>Server HOTP service</div>
        <div class="inner-wrap">
            <label>User ID
                <input type="text" name="userId" id="userId" placeholder="hex-coded user ID"/>
                <span>User ID generated by the service</span>
            </label>

            <label>User context
                <input type="text" name="userCtx" id="userCtx" placeholder="binary blob"/>
                <span>User context generated by the service, used for further authentication requests</span>
            </label>

            <label>HOTP code
                <input type="text" name="hotpCode" id="hotpCode" placeholder="123 456"/>
                <span>HOTP code to authenticate with. If entered, HOTP authentication method will be used.</span>
            </label>

            <label>Password
                <input type="text" name="password" id="password" placeholder="lorem ipsum"/>
                <span>Password authenticate with. If entered, password authentication method will be used.</span>
            </label>
        </div>

        <div class="section"><span>3</span>Configuration</div>
        <div class="inner-wrap">
            <label>API Key
                <input type="text" name="apiKey" id="apiKey" value="TEST_API"/>
                <span>Your EB API key</span>
            </label>

            <label>User object ID
                <input type="text" name="userObjectID" id="userObjectID" placeholder="UserObjectID"/>
                <span>User object used for HOTP verification.
                    <a onclick="$('#endpoint').val(defaults.uoidHotp);">HOTP UO</a>,
                    <a onclick="$('#endpoint').val(defaults.uoidPasswd);">Passwd UO</a>
                    </span>
            </label>

            <label>ProcessData method
                <input type="text" name="processDataMethod" id="processDataMethod" value="" placeholder="ProcessData method"/>
                <span>
                </span>
            </label>

            <label>Endpoint
                <input type="text" name="endpoint" id="endpoint" placeholder="endpoint.address.com"/>
                <span>Hostname of the EB API
                    <a onclick="$('#endpoint').val(defaults.site1);">site1</a>,
                    <a onclick="$('#endpoint').val(defaults.site2);">site2</a></span>
            </label>

            <label>Method
                <select id="requestMethod" name="requestMethod">
                    <option value="POST">POST</option>
                    <option value="GET">GET</option>
                </select>
            </label>

            <label>Scheme
                <select id="requestScheme" name="requestScheme">
                    <option value="https">https</option>
                    <option value="http">http</option>
                </select>
            </label>

            <label>AES encryption key
                <input type="text" name="aesKey" id="aesKey" value="1234567890123456789012345678901234567890123456789012345678901234"/>
                <span>Hexcoded encryption API key
                </span>
            </label>

            <label>MAC key
                <input type="text" name="macKey" id="macKey" value="2224262820223456789012345678901234567890123456789012345678901234"/>
                <span>Hexcoded hmac API key
                </span>
            </label>

            <label>HOTP digits
                <input type="text" name="hotpDigits" id="hotpDigits" value="8"/>
                <span>Number of digits in HOTP code
                </span>
            </label>
        </div>

        <div class="section"><span>2</span>Response</div>
        <div class="inner-wrap">
            <label>Status code
                <input type="text" name="hotpStatus" id="hotpStatus" placeholder="Authentication status code"/>
                <span>Authentication result, 9000 means success</span>
            </label>

            <label>Updated user context
                <input type="text" name="newUserCtx" id="newUserCtx" placeholder="binary blob"/>
                <span>User context updated by the service, used for further authentication requests.
                <a onclick="updateCtx()">Update context in the request</a>
                </span>
            </label>
        </div>
        <div class="button-section">
            <input type="button" id="btnAuthenticate" value="Authenticate"/>
            <input type="button" id="btnAuthenticateUpdate" value="Authenticate &amp; Update"/>
        </div>
    </form>
</div>

<label for="reqRest">Request: </label>
<div id="reqRest" class="logbox"></div>
<br/>

<label for="status">Log: </label>
<div id="status" class="logbox"></div>

<script>
    "use strict";
    $('#endpoint').val(defaults.site);

    // Shortcuts.
    var ahotp = $("#hotpCode");
    var apass = $("#password");
    var auoid = $('#userObjectID');
    var ameth = $('#processDataMethod');

    ahotp.keyup(fixAuthFields);
    apass.keyup(fixAuthFields);
    auoid.val(defaults.uoidHotp);
    ameth.val(defaults.methodHotp);
    fixAuthFields();

    function fixAuthFields(){
        var hotpCode = ahotp.val() || '';
        var passwd = apass.val() || '';
        hotpCode = hotpCode.trim();
        passwd = passwd.trim();

        if (passwd.length == 0 && hotpCode.length == 0){
            ahotp.prop('disabled', false);
            apass.prop('disabled', false);

        } else if (passwd.length == 0){
            auoid.val(defaults.uoidHotp);
            ameth.val(defaults.methodHotp);
            apass.val('');
            ahotp.prop('disabled', false);
            apass.prop('disabled', true);

        } else {
            auoid.val(defaults.uoidPasswd);
            ameth.val(defaults.methodPasswd);
            ahotp.prop('disabled', true);
            apass.prop('disabled', false);

        }
    }

    function set_request(msg){
        $("#reqRest")[0].innerHTML = msg;
    }

    function display_message(msg) {
        $("#status")[0].innerHTML = msg;
    }

    function formatDate(date) {
        var hours = date.getHours();
        var minutes = date.getMinutes();
        var sec = date.getSeconds();
        var milli = date.getMilliseconds();
        var strTime = sprintf("%02d:%02d:%02d.%03d", hours, minutes, sec, milli);
        return date.getMonth()+1 + "/" + date.getDate() + "/" + date.getFullYear() + " " + strTime;
    }

    function append_message(msg) {
        var status = $("#status");
        var newMsg = formatDate(new Date()) + " - " + msg;
        status.html(status.html() + "<br/>\n" + newMsg);
    }

    function log(msg){
        console.log(msg);
        append_message(msg);
    }

    function getSettings(){
        var apiKey = $('#apiKey').val();
        var keyId = parseInt($('#userObjectID').val(), 16);
        var endpoint = $('#endpoint').val();
        var method = $('#requestMethod').val();
        var scheme = $('#requestScheme').val();

        return {
            remoteEndpoint: endpoint,
            remotePort: 11180,
            requestMethod: method,
            requestScheme: scheme,
            requestTimeout: 7000,
            debuggingLog: true,
            apiKey: apiKey,
            apiKeyLow4Bytes: keyId,
            userObjectId : keyId
        };
    }

    function getURLParameter(name) {
        return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null;
    }

    function updateCtx(){
        var newCtx = $('#newUserCtx').val();
        if (!newCtx || newCtx.length==0){
            console.log("Empty CTX");
            return;
        }

        $('#userCtx').val(newCtx);
    }

    function pad8b(x){
        return (x.length<16) ? (('0'.repeat(16-x.length))+x) : x
    }

    function revHex(x){
        if ((x.length & 1) == 1){
            x = '0'+x;
        }

        var ln = x.length;
        var z = "";
        var i;
        for(i=0; i<ln; i+=2){
            z += x.substring(ln-i-2, ln-i);
        }

        return z;
    }

    function generate(bugCtr){
        bugCtr = bugCtr || false;

        var digits = $('#hotpDigits').val();
        var hotpSecret = $('#hotpSecret').val();
        var hotpSecretBits = sjcl.codec.hex.toBits(hotpSecret);
        var hotpCtr = pad8b($('#hotpCtr').val());
        var bn = new sjcl.bn(hotpCtr);

        // Initial conversion.
        if (bugCtr && !bn.greaterEquals(new sjcl.bn('100000000000000'))){
            hotpCtr = revHex(pad8b(hotpCtr));
            console.log("Initial conversion to: " + hotpCtr);
        }

        // Compute HOTP code.
        var hotpCode = eb.comm.hotp.hotpCompute(hotpSecretBits, hotpCtr, digits);
        var hotpCodeStr = sprintf("%0"+digits+"d", hotpCode);

        // Incrementation.
        if (bugCtr){
            bn = new sjcl.bn(revHex(hotpCtr));
            hotpCtr = revHex(pad8b(bn.addM(1).toString().replace(/^0x/, '')));

        } else {
            bn = new sjcl.bn(hotpCtr);
            hotpCtr = pad8b(bn.addM(1).toString().replace(/^0x/, ''));

        }

        $("#password").val('');
        $('#hotpCtr').val(hotpCtr);
        $('#hotpCodeDiv').html(hotpCodeStr);
        $('#hotpCode').val(hotpCodeStr);
        fixAuthFields();
    }

    function finished(response){
        var statusElem = $('#hotpStatus');
        var status = sprintf("%04X", response.hotpStatus);
        if (response.hotpStatus == eb.comm.status.SW_STAT_OK){
            status += ' - Authenticated successfully';
        } else if (response.hotpStatus == eb.comm.status.SW_AUTH_TOO_MANY_FAILED_TRIES){
            status += ' - Failed, too many attempts';
        } else if (response.hotpStatus == eb.comm.status.SW_HOTP_TOO_MANY_FAILED_TRIES){
            status += ' - Failed, too many HOTP attempts';
        } else if (response.hotpStatus == eb.comm.status.SW_HOTP_WRONG_CODE){
            status += ' - Failed, invalid HOTP code';
        } else {
            status += ' - Failed, unknown error';
        }

        statusElem.val(status);
        if (response.hotpStatus == eb.comm.status.SW_STAT_OK){
            statusElem.css({ 'background': '#ddffdd' });
        } else {
            statusElem.css({ 'background': '#ffdddd' });
        }

        if (response.hotpUserCtx){
            $('#newUserCtx').val(sjcl.codec.hex.fromBits(response.hotpUserCtx));
        }

        if (updateCtxFlag){
            updateCtx();
        }
    }

    function requestSimple(){
        var h = sjcl.codec.hex;
        var aesKey = $('#aesKey').val();
        var macKey = $('#macKey').val();
        var pDataMethod = $('#processDataMethod').val();

        // Flush old messages.
        display_message("");
        set_request("");

        var logger = function(msg) {
            append_message(msg);
        };

        var endpointConfig = getSettings();
        var userConfig = {
            aesKey: aesKey,
            macKey: macKey,
            callRequestType: pDataMethod
        };

        var userId = $('#userId').val();
        var userCtx = $('#userCtx').val();
        var hotpCode = $('#hotpCode').val();
        var password = $('#password').val();
        var reqConfig = {hotp:{
            'userId': userId,
            'userCtx': userCtx
        }};

        if (hotpCode && hotpCode.length > 0){
            reqConfig.hotp.hotpCode = hotpCode
        } else {
            reqConfig.hotp.passwd = sjcl.hash.sha256.hash(password);
        }

        var request = new eb.comm.hotp.authHotpUserRequest(reqConfig);
        request.configure(userConfig);
        request.configure(endpointConfig);

        // Logging settings.
        request.logger = logger;

        // Callbacks settings.
        request.done(function(response, requestObj, data) {
            log("DONE! " + response.toString());
            finished(response);

        }).fail(function(failType, data){
            log("fail! type=" + failType);
            if (failType == 0x2){
                log("Fail msg: " + data.response.toString());
                finished(data.response);
            }

        }).always(function(request, data){
            log("it is over...");
        });

        // Build the request so we can display request in the form.
        request.build();
        set_request(sprintf("%s<br/>\n%s<br/>\n%s<br/>\n",
                request.getApiUrl(),
                JSON.stringify(request.getApiRequestData()),
                JSON.stringify(request.getSocketRequest())));

        // Do the call.
        request.doRequest();
    }

    $(function(){
        // Start random number collectors.
        sjcl.random.startCollectors();

        // Parse query parameters - init hotp.
        var hotpKey = getURLParameter('key');
        var userId = getURLParameter('userId');
        var userCtx = getURLParameter('userCtx');
        var hotpDigits = getURLParameter('digits');
        if (hotpKey !== undefined){
            $('#hotpSecret').val(hotpKey);
        }
        if (userId !== undefined){
            $('#userId').val(userId);
        }
        if (userCtx !== undefined){
            $('#userCtx').val(userCtx);
        }
        if (hotpDigits !== undefined){
            $('#hotpDigits').val(hotpDigits);
        }

        // Button click handling.
        $('#btnAuthenticate').click(function(){
            updateCtxFlag=false;
            requestSimple();
        });

        // Button click handling.
        $('#btnAuthenticateUpdate').click(function(){
            updateCtxFlag=true;
            requestSimple();
        });

        $('#btnGenerate').click(function(){
            generate();
        });

        $('#btnGenerateBug').click(function(){
            generate(true);
        });
    });

</script>

</body>
</html>